// For format details, see https://aka.ms/devcontainer.json. For config options, see the README at:
// https://github.com/microsoft/vscode-dev-containers/tree/v0.192.0/containers/javascript-node
{
  "name": "Biosimulations",
  "dockerComposeFile": "../docker-compose.yml",
  "service": "combine-api",
  "workspaceFolder": "/workspace/apps/combine-api",

    // Add the IDs of extensions you want installed when the container is created.
  "customizations": {
    "vscode": {
      "extensions": [
        "ms-python.python",
        "ms-python.vscode-pylance",
        "eamodio.gitlens",
        "github.copilot"
      ]
    }
    // "settings": {
    //   "terminal.integrated.shell.linux": "/bin/bash"
    // },
    // "files": {
    //   "/root/.bashrc": {
    //     "content": "export PATH=$PATH:/workspace/node_modules/.bin"
    //   }
    // }
  },

  "features": {
    "github-cli": "latest",
    "python": "3.10"
  },

  // Use 'forwardPorts' to make a list of ports inside the container available locally.
  // "forwardPorts": [4222, 3333, 4200],

  // Use 'postCreateCommand' to run commands after the container is created.
  "postCreateCommand": "poetry env use 3.10 && poetry install --no-cache",
  "postStartCommand": 
            [   "poetry", "run", "python", "-m", "gunicorn",
                "--bind", "0.0.0.0:3333", 
                "combine_api.app:app",
                "--workers", "2",
                "--threads", "4",
                "--worker-class", "gthread",
                "--max-requests", "1000",
                "--timeout", "30",
                "--keep-alive", "5",
                "--worker-tmp-dir", "/dev/shm",
                "--log-level", "debug",
                "--log-file", "-"
            ],

  // check ports: netstat -tuln

  // Comment out connect as root instead. More info: https://aka.ms/vscode-remote/containers/non-root.
  "remoteUser": "vscode"

  // once container is built run: npx nx run platform:serve --host 0.0.0.0 --port 4200
}
