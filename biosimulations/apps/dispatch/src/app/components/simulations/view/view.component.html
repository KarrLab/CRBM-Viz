<biosimulations-tab-page (selectedTabChange)="selectedTabChange($event)">
  <biosimulations-tab-page-tab heading="Overview" icon="overview">
    <div
      class="spinner-container"
      *ngIf="(formattedSimulation$ | async) === null"
    >
      <biosimulations-spinner> </biosimulations-spinner>
    </div>
    <ng-container *ngIf="formattedSimulation$ | async as simulation">
      <p>
        <b class="highlight-primary">Simulation #{{ simulation.id }}</b
        ><br />
        {{ simulation.name }}
      </p>

      <table class="icon-list">
        <tr>
          <th>
            <biosimulations-icon icon="download"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Project:</span>{{ ' '
            }}<a [href]="simulation.projectUrl"
              >COMBINE/OMEX archive<ng-container *ngIf="simulation.projectSize">
                ({{ simulation.projectSize }})</ng-container
              ></a
            >
          </td>
        </tr>
        <tr>
          <th>
            <biosimulations-icon icon="simulator"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Simulator:</span>{{ ' '
            }}<a [href]="simulation.simulatorUrl" target="_blank"
              >{{ simulation.simulator }} {{ simulation.simulatorVersion }}</a
            >
          </td>
        </tr>
      </table>

      <table class="icon-list">
        <tr>
          <th>
            <biosimulations-icon icon="download"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Outputs:</span>{{ ' ' }}
            <a
              [href]="simulation.resultsUrl"
              *ngIf="
                simulation.statusSucceeded && simulation.resultsSize !== 'N/A';
                else noResults
              "
              >Zip archive ({{ simulation.resultsSize }})</a
            >
            <ng-template #noResults>N/A</ng-template>
          </td>
        </tr>
      </table>

      <table class="icon-list">
        <tr>
          <th>
            <biosimulations-icon icon="status"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Status:</span> {{ simulation.statusLabel }}
            <biosimulations-icon
              icon="spinner"
              *ngIf="simulation.statusRunning"
            ></biosimulations-icon>
          </td>
        </tr>
        <tr>
          <th>
            <biosimulations-icon icon="duration"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Runtime:</span> {{ runTime$ | async }}
          </td>
        </tr>
        <tr>
          <th>
            <biosimulations-icon icon="date"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Submitted</span>: {{ simulation.submitted }}
          </td>
        </tr>
        <tr>
          <th>
            <biosimulations-icon icon="date"></biosimulations-icon>
          </th>
          <td>
            <span class="heading">Updated:</span> {{ simulation.updated }}
          </td>
        </tr>
      </table>
    </ng-container>
  </biosimulations-tab-page-tab>

  <biosimulations-tab-page-tab
    heading="Design chart"
    icon="write"
    urlHashFragment="design-viz"
  >
    <form
      [formGroup]="formGroup"
      class="partial-width design-visualization"
      *ngIf="hasData; else noSedDatasets"
    >
      <mat-form-field appearance="fill">
        <mat-label>How would you like to visualize the results of your simulation?</mat-label>
        <mat-select
          formControlName="visualizationType"
          required
          (selectionChange)="selectVisualizationType()"
          disableOptionCentering
        >
          <mat-option
            *ngFor="let visualizationType of visualizationTypes"
            [value]="visualizationType"
          >
            {{ visualizationType }}
          </mat-option>
        </mat-select>
        <biosimulations-icon icon="write" matPrefix></biosimulations-icon>
        <mat-hint
          >
          <p>Choose to either use a simple form to design a two-dimensional line or scatter plot, or upload any visualization in Vega format <a href="https://vega.github.io/vega/" target="_blank"><biosimulations-icon icon="link"></biosimulations-icon></a>.</p>

          <p>Vega is a powerful format for describing data visualizations. By capturing how data should be used to paint visual elements, Vega enables reusable visualizations that can be re-painted with data from multiple simulations. Vega can also capture interactive and publication-quality graphics.</p>

          <p>Recommendations for using Vega to visualize simulation results are available here <a href="https://biosimulators.org/standards/data-viz"><biosimulations-icon icon="link"></biosimulations-icon></a>. Example visualizations for simulation predictions are available here <a href="https://github.com/biosimulators/Biosimulators_test_suite/tree/dev/examples" target="_blank"><biosimulations-icon icon="link"></biosimulations-icon></a>.</p>
        </mat-hint>
      </mat-form-field>

      <ng-container *ngIf="selectedVisualizationType === VisualizationType.lineScatter2d" formGroupName="lineScatter2d">
        <mat-form-field appearance="fill">
          <mat-label>Select the number of rows of subplots</mat-label>
          <input
            matInput
            formControlName="rows"
            type="number"
            min="1"
            step="1"
            required
            (ngModelChange)="setVizGrid()"
          />
          <biosimulations-icon icon="report" matPrefix></biosimulations-icon>
          <mat-hint>runBioSimulations can display a grid of subplots. Select the number of rows of subplots that you would like to display.</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Select the number of columns of subplots</mat-label>
          <input
            matInput
            formControlName="cols"
            type="number"
            min="1"
            step="1"
            required
            (ngModelChange)="setVizGrid()"
          />
          <biosimulations-icon icon="report" matPrefix></biosimulations-icon>
          <mat-hint>runBioSimulations can display a grid of subplots. Select the number of columns of subplots that you would like to display.</mat-hint>
        </mat-form-field>

        <mat-tab-group mat-align-tabs="start" formArrayName="subplots" class="subplots">
          <mat-tab
            *ngFor="let subplot of lineScatter2dSubplotsFormArray.controls; index as iSubplot"
          >
            <ng-template matTabLabel>Subplot {{ (iSubplot + 1).toString() }}</ng-template>
            <ng-template matTabContent [formGroupName]="iSubplot">
              <mat-form-field appearance="fill">
                <mat-label>Choose whether to enable or disable the subplot</mat-label>
                <mat-select
                  formControlName="enabled"
                  required
                  (selectionChange)="build2dViz()"
                  disableOptionCentering
                >
                  <mat-option
                    *ngFor="let subplotEnabledType of subplotEnabledTypes"
                    [value]="subplotEnabledType"
                  >
                    {{ subplotEnabledType }}
                  </mat-option>
                </mat-select>
                <biosimulations-icon icon="visible" matPrefix></biosimulations-icon>
                <mat-hint
                  >Choose whether to enable or disable the subplot.</mat-hint
                >
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Select the number of curves to display</mat-label>
                <input
                  matInput
                  formControlName="numCurves"
                  type="number"
                  min="0"
                  step="1"
                  required
                  (change)="setNumCurves(iSubplot)"
                />
                <biosimulations-icon icon="report" matPrefix></biosimulations-icon>
                <mat-hint>runBioSimulations can display one or more curves per subplots. Select the number of curves that you would like to display.</mat-hint>
              </mat-form-field>

              <div class="curves" formArrayName="curves">
                <div class="icon-label-input">
                  <biosimulations-icon icon="report" matPrefix></biosimulations-icon>
                  <div class="label-input">
                    <mat-label>Select the data for each curve *</mat-label>
                    <div class="input">
                      <div class="input-heading">No.</div>
                      <div class="input-heading">X data set</div>
                      <div class="input-heading">Y data set</div>
                      <ng-container *ngFor="let curve of subplotCurves[iSubplot]; index as iCurve" [formGroupName]="iCurve">
                        <div class="input-row curve-num">{{ (iCurve + 1).toString() }}.</div>
                        <div class="input-row">
                          <mat-select
                            formControlName="xData"
                            required
                            (selectionChange)="build2dViz()"
                            disableOptionCentering
                          >
                            <mat-optgroup
                              *ngFor="let sedDocument of combineResultsStructure"
                              [label]="sedDocument.location"
                            >
                              <mat-optgroup
                                *ngFor="let report of sedDocument.reports"
                                [label]="report.id"
                              >
                                <mat-option
                                  *ngFor="let dataset of report.datasets"
                                  [value]="dataset._id"
                                >
                                  {{ dataset.label }}
                                </mat-option>
                              </mat-optgroup>
                            </mat-optgroup>
                          </mat-select>
                        </div>
                        <div class="input-row">
                          <mat-select
                            formControlName="yData"
                            required
                            (selectionChange)="build2dViz()"
                            disableOptionCentering
                          >
                            <mat-optgroup
                              *ngFor="let sedDocument of (combineResultsStructure$ | async)"
                              [label]="sedDocument.location"
                            >
                              <mat-optgroup
                                *ngFor="let report of sedDocument.reports"
                                [label]="report.id"
                              >
                                <mat-option
                                  *ngFor="let dataset of report.datasets"
                                  [value]="dataset._id"
                                >
                                  {{ dataset.label }}
                                </mat-option>
                              </mat-optgroup>
                            </mat-optgroup>
                          </mat-select>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </div>
                <mat-hint>Select the SED data sets for the X and Y data of each curve.</mat-hint>
              </div>

              <mat-form-field appearance="fill">
                <mat-label>Select a scale for the x-axis</mat-label>
                <mat-select
                  formControlName="xAxisType"
                  required
                  (selectionChange)="build2dViz()"
                  disableOptionCentering
                >
                  <mat-option
                    *ngFor="let axisLabelType of axisLabelTypes"
                    [value]="axisLabelType.type"
                  >
                    {{ axisLabelType.label }}
                  </mat-option>
                </mat-select>
                <biosimulations-icon
                  icon="visualization"
                  matPrefix
                ></biosimulations-icon>
                <mat-hint>Select a scale such as "linear" or "logarithmic".</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Select a scale for the y-axis</mat-label>
                <mat-select
                  formControlName="yAxisType"
                  required
                  (selectionChange)="build2dViz()"
                  disableOptionCentering
                >
                  <mat-option
                    *ngFor="let axisLabelType of axisLabelTypes"
                    [value]="axisLabelType.type"
                  >
                    {{ axisLabelType.label }}
                  </mat-option>
                </mat-select>
                <biosimulations-icon
                  icon="visualization"
                  matPrefix
                ></biosimulations-icon>
                <mat-hint>Select a scale such as "linear" or "logarithmic".</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Select a type of plot</mat-label>
                <mat-select
                  formControlName="scatterTraceMode"
                  required
                  (selectionChange)="build2dViz()"
                  disableOptionCentering
                >
                  <mat-option
                    *ngFor="let scatterTraceModeLabel of scatterTraceModeLabels"
                    [value]="scatterTraceModeLabel.mode"
                  >
                    {{ scatterTraceModeLabel.label }}
                  </mat-option>
                </mat-select>
                <biosimulations-icon
                  icon="visualization"
                  matPrefix
                ></biosimulations-icon>
                <mat-hint>Select a type of plot such as "line" or "scatter".</mat-hint>
              </mat-form-field>
            </ng-template>
          </mat-tab>
        </mat-tab-group>
      </ng-container>

      <ng-container *ngIf="selectedVisualizationType === VisualizationType.vega" formGroupName="vega">
        <mat-form-field appearance="fill">
          <biosimulations-icon icon="project" matPrefix></biosimulations-icon>
          <mat-label>Select a Vega file</mat-label>
          <ngx-mat-file-input
            formControlName="vegaFile"
            accept=".json"
            [multiple]="false"
            [required]="true"
            placeholder="Vega file"
          ></ngx-mat-file-input>
          <mat-error *ngIf="!vegaFileFormControl.valid">
            The selected file is not a syntactically valid Vega document.
          </mat-error>
        </mat-form-field>

        <div *ngIf="vegaDataSetSedmlLocationReportIdsFormArray.controls.length">
          <mat-label>Map SED reports to the data sets of the Vega visualization</mat-label>
          <div formArrayName="vegaDataSetSedmlLocationReportIds" class="form-array">
            <ng-container>
              <div class="form-array-head">SED document location &amp; report id</div>
              <biosimulations-icon icon="longRightArrow" class="form-array-head sed-to-vega-arrow"></biosimulations-icon>
              <div class="form-array-head">Vega data set name</div>
            </ng-container>

            <ng-container *ngFor="let vegaDataSetSedmlLocationReportId of vegaDataSetSedmlLocationReportIdsFormArray.controls; index as iVegaDataSetSedReport; last as isLast">
              <mat-form-field appearance="fill" class="form-array-item-content">
                <mat-select
                  [formControlName]="iVegaDataSetSedReport"
                  required
                  (selectionChange)="buildVegaVizData()"
                  disableOptionCentering
                >
                  <mat-option
                    *ngFor="let sedmlLocationsReportId of (sedmlLocationsReportIds$ | async)"
                    [value]="sedmlLocationsReportId.id"
                  >
                    {{ sedmlLocationsReportId.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <biosimulations-icon icon="longRightArrow" class="sed-to-vega-arrow"></biosimulations-icon>

              <div class="form-array-item-label" [title]="vegaDataSets[iVegaDataSetSedReport].name">{{ vegaDataSets[iVegaDataSetSedReport].name }}</div>
            </ng-container>
          </div>

          <div class="form-array-hint mat-hint">
            To paint Vega diagrams with simulation results, select the simulation output (SED-ML report) that should be mapped to each  input of the diagram (Vega data set).
          </div>
        </div>
      </ng-container>
    </form>

    <ng-template #noSedDatasets>
      <span class="info-message">The execution of the COMBINE/OMEX archive did not generate any data. runBioSimulations visualizes simulation results outputted via data sets of SED reports.</span>
    </ng-template>
  </biosimulations-tab-page-tab>

  <biosimulations-tab-page-tab
    heading="Visualize chart"
    icon="chart"
    urlHashFragment="viz"
    [fullHeight]="true"
    [disabled]="
      (
        selectedVisualizationType === VisualizationType.lineScatter2d
        && !lineScatter2dValid
      )
      || (
        selectedVisualizationType === VisualizationType.vega
        && (vegaSpec$ | async) === null
      )
    "
  >
    <biosimulations-plotly-visualization
      [dataLayout]="vizDataLayout$ | async"
      *ngIf="selectedVisualizationType === VisualizationType.lineScatter2d"
    >
    </biosimulations-plotly-visualization>

    <biosimulations-vega-visualization
      *ngIf="selectedVisualizationType === VisualizationType.vega"
      [spec]="vegaSpec$"
      (refreshed)="vegaRefreshHandler()"
      (error)="vegaErrorHandler()"
    >
    </biosimulations-vega-visualization>
  </biosimulations-tab-page-tab>

  <biosimulations-tab-page-tab
    heading="Log"
    icon="logs"
    urlHashFragment="log"
    [disabled]="(statusRunning$ | async) || (logs$ | async) === null"
  >
    <ng-container *ngIf="logs$ | async as logs">
      <ng-container *ngIf="formattedSimulation$ | async as sim">
        <biosimulations-simulation-log
          [status]="sim.status"
          [rawLog]="logs.raw"
          [structuredLog]="logs.structured"
        >
        </biosimulations-simulation-log>
      </ng-container>
    </ng-container>
  </biosimulations-tab-page-tab>
</biosimulations-tab-page>
