<div class="spinner-container full-height has-breadcrumbs" *ngIf="(loaded$ | async) !== true">
  <biosimulations-spinner></biosimulations-spinner>
</div>

<ng-container *ngIf="jsonLdData$ | async as jsonLdData">
  <biosimulations-json-ld [json]="jsonLdData"></biosimulations-json-ld>
</ng-container>

<ng-container *ngIf="projectMetadata$ | async as projectMetadata">
  <ng-container *ngIf="simulationRun$ | async as simulationRun">
    <div class="display-data">
      <!-- Start Left Column-->
      <biosimulations-project-metadata
        [project]="projectMetadata"
        [simulationRun]="simulationRun"
        [projectSummary]="projectSummary$ | async">
      </biosimulations-project-metadata>
      <!-- End Left Column -->

      <!-- Start Right Column -->
      <mat-card class="viz-card">
        <mat-card-content class="viz-card-content">
          <!-- Start ReRun Simulation Button -->
          <mat-card-header class="viz-card-header">
            <mat-card-actions class="rerun-sim-button-container">
              <button
                mat-raised-button
                class="rerun-button"
                (click)="promptReRun()"
                matTooltip="This feature is currently being developed!">
                <div style="display: inline-block">
                  <span>Customize & ReRun Simulation</span>
                  <biosimulations-icon class="rerun-icon" icon="redo"></biosimulations-icon>
                </div>
              </button>
            </mat-card-actions>
          </mat-card-header>
          <!-- End ReRun Simulation Button -->

          <mat-tab-group #tabGroup preserveContent="true" [dynamicHeight]="true" [selectedIndex]="selectedTabIndex">
            <!-- Start Visualizations Tab -->
            <mat-tab class="right-col-tab figures" label="Figures">
              <mat-card class="plots-card">
                <mat-grid-list
                  *ngFor="let plotVisualization of plotVisualizations$ | async"
                  cols="1"
                  rowHeight="525px"
                  gutterSize="20"
                  cdkDropList
                  (cdkDropListDropped)="drop($event)">
                  <mat-grid-tile class="figure-card" cdkDrag>
                    <mat-grid-tile-header
                      class="figure-card-header"
                      style="background-color: #2196f3; height: 6%"
                      cdkDragHandle>
                      {{ plotVisualization.name }}
                    </mat-grid-tile-header>
                    <div class="plotparent">
                      <div class="figure-card-placeholder" *cdkDragPlaceholder></div>
                      <biosimulations-project-visualization
                        [visualization]="plotVisualization"
                        [plotTitle]="plotVisualization.name"
                        [projectTitle]="projectMetadata.title">
                      </biosimulations-project-visualization>
                    </div>
                  </mat-grid-tile>
                </mat-grid-list>
              </mat-card>
            </mat-tab>
            <!-- End Visualizations Tab -->

            <!-- Begin Project files Tab -->
            <mat-tab class="right-col-tab files" label="Download">
              <mat-card class="files-card">
                <mat-card-content>
                  <!-- OMEX File -->
                  <mat-expansion-panel class="files-item omex" expanded="true">
                    <mat-expansion-panel-header class="item-expansion-header"
                      >Simulation specification (COMBINE/OMEX archive)</mat-expansion-panel-header
                    >
                    <mat-card-content>
                      <div *ngIf="projectFiles$ | async as files">
                        <biosimulations-project-files
                          id="content"
                          [files]="files"
                          [usesMaster]="false"
                          [usesMetadata]="false">
                        </biosimulations-project-files>
                      </div>
                    </mat-card-content>
                  </mat-expansion-panel>

                  <div class="files-separator 1"></div>

                  <!-- Spec Files (sbml, manifest, etc) -->
                  <mat-expansion-panel class="files-item specContent">
                    <mat-expansion-panel-header class="item-expansion-header"
                      >Contents of simulation specification</mat-expansion-panel-header
                    >
                    <mat-card-content>
                      <div *ngIf="files$ | async as files">
                        <biosimulations-project-files
                          id="content"
                          [files]="files"
                          [usesMaster]="true"
                          [usesMetadata]="true">
                        </biosimulations-project-files>
                      </div>
                    </mat-card-content>
                  </mat-expansion-panel>

                  <div class="files-separator 2"></div>

                  <!-- Output Data Files -->
                  <mat-expansion-panel class="files-item outputs">
                    <mat-expansion-panel-header class="item-expansion-header"
                      >Simulation outputs</mat-expansion-panel-header
                    >
                    <mat-card-content>
                      <div *ngIf="outputs$ | async as files">
                        <biosimulations-project-files
                          id="content"
                          [files]="files"
                          [usesMaster]="false"
                          [usesMetadata]="false">
                        </biosimulations-project-files>
                      </div>
                    </mat-card-content>
                  </mat-expansion-panel>
                </mat-card-content>
              </mat-card>
            </mat-tab>
            <!-- End Project Files Tab -->

            <!-- Begin Project Details Tab -->
            <mat-tab class="right-col-tab details" label="Details">
              <mat-card class="details-card">
                <mat-card-content>
                  <!-- Start Details Display -->
                  <div *ngIf="projectSummary$" fxGrid>
                    <!-- Biology, simulation, provenance, & identifiers information -->
                    <div
                      *ngIf="
                        projectMetadata?.modelSimulation?.length ||
                        simulationRun?.length ||
                        projectMetadata?.provenance?.length ||
                        projectMetadata?.identifiers?.length
                      "
                      class="attributes-column ragged-column"
                      fxLayout="column"
                      fxInlineBlock
                      fxFlex.lt-lg="100%">
                      <!-- project metadata -->
                      <ng-container
                        *ngTemplateOutlet="
                          sectionsTemplate;
                          context: { sections: projectMetadata?.modelSimulation || [] }
                        "></ng-container>
                      <!-- simulation run metadata -->
                      <ng-container
                        *ngTemplateOutlet="sectionsTemplate; context: { sections: simulationRun || [] }"></ng-container>
                      <!-- project metadata -->
                      <ng-container
                        *ngTemplateOutlet="
                          sectionsTemplate;
                          context: { sections: projectMetadata?.provenance || [] }
                        "></ng-container>
                      <ng-container
                        *ngTemplateOutlet="
                          sectionsTemplate;
                          context: { sections: projectMetadata?.identifiers || [] }
                        "></ng-container>
                      <!-- template -->
                      <ng-template #sectionsTemplate let-sections="sections">
                        <!-- Start Individual Detail Item Expansion -->
                        <div
                          class="details-expansion-item"
                          *ngFor="let section of sections; let i = index; panelExpanded: i && i === 0">
                          <div *ngIf="isPanelExpanded; else notExpanded">
                            <mat-expansion-panel expanded="isPanelExpanded">
                              <mat-expansion-panel-header class="item-expansion-header">
                                {{ section.title }}
                              </mat-expansion-panel-header>
                              <table class="icon-list" aria-label="metadata table">
                                <tr *ngFor="let item of section.items" fxLayout="row">
                                  <th>
                                    <biosimulations-icon [icon]="item.icon"></biosimulations-icon>
                                  </th>
                                  <td>
                                    <b>{{ item.title }}:</b>{{ ' ' }}
                                    <a [href]="item.url" rel="noopener" target="_blank" *ngIf="item.url; else noHref">
                                      {{ item.value }}
                                    </a>
                                    <ng-template #noHref>{{ item.value }}</ng-template>
                                  </td>
                                </tr>
                              </table>
                            </mat-expansion-panel>
                            <!-- Stop Individual Detail Item Expansion -->
                          </div>

                          <ng-template #notExpanded>
                            <mat-expansion-panel class="details-expansion-item" expanded="false">
                              <mat-expansion-panel-header class="item-expansion-header">
                                {{ section.title }}
                              </mat-expansion-panel-header>
                              <table class="icon-list" aria-label="metadata table">
                                <tr *ngFor="let item of section.items" fxLayout="row">
                                  <th>
                                    <biosimulations-icon [icon]="item.icon"></biosimulations-icon>
                                  </th>
                                  <td>
                                    <b>{{ item.title }}:</b>{{ ' ' }}
                                    <a [href]="item.url" rel="noopener" target="_blank" *ngIf="item.url; else noHref">
                                      {{ item.value }}
                                    </a>
                                    <ng-template #noHref>{{ item.value }}</ng-template>
                                  </td>
                                </tr>
                              </table>
                            </mat-expansion-panel>
                            <!-- Stop Individual Detail Item Expansion -->
                          </ng-template>
                        </div>
                      </ng-template>
                    </div>
                  </div>
                  <!-- End Details Display -->
                </mat-card-content>
              </mat-card>
            </mat-tab>

            <!-- Begin ReRun Notebook Tab -->
            <!--<mat-tab
              label="ReRun"
              (click)="isReRunTabExpanded = !isReRunTabExpanded"
              [ngClass]="{ 'full-width-tab-content': isReRunTabExpanded }">
              <mat-card>
                <mat-card-content>
                  <mat-expansion-panel expanded="true" disabled="true">
                    <mat-expansion-panel-header
                      class="item-expansion-header-under-dev"
                      matTooltip="Customize and ReRun a Simulation. This feature will be available soon!">
                      This feature is currently under development.
                    </mat-expansion-panel-header>-->

                  <!-- Case: Using Deepnote -->
                  <!--<div class="notebook-container deepnote">
                    <iframe
                      class="notebook-intro"
                      title="Embedded cell output"
                      src="https://embed.deepnote.com/717d0b91-cf50-4435-a706-ae083705b28e/0cdec188065948bd8f5e5411ab8a821c/8d7ad546db4947aa948470e10b51ad3f?height=1091"
                      width="100%"
                      height="800px">
                    </iframe>
                    <iframe
                      class="notebook-main"
                      width="100%"
                      height="800px"
                      src="https://embed.deepnote.com/717d0b91-cf50-4435-a706-ae083705b28e/0cdec188065948bd8f5e5411ab8a821c/d2a0c22bf8904116b4c2aba4b27a6100?height=7751"
                      frameborder="0"
                      allowfullscreen>
                    </iframe>
                  </div>

                    <!-- Case: Using Binder -->
                    <!--<div class="notebook-container binder">
                      <iframe
                        class="binder-notebook-content"
                        width="100%"
                        height="100%"
                        src="https://mybinder.org/v2/gh/AlexPatrie/biosimulators-sandbox-test-repo-4.git/HEAD"
                        target="_parent"
                        frameborder="0"
                        allowfullscreen>
                      </iframe>
                    </div>-->
                    <!-- Case: Using Jupyterlite/Github Pages-->
                    <!--<div class="notebook-container jupyterlite">
                      <iframe
                        class="jupyterlite-notebook-content"
                        title="Simulation Sandbox"
                        width="100%"
                        height="100%"
                        src="https://alexpatrie.github.io/biosimulators-sandbox-test-repo-2/repl/index.html"
                        frameborder="0"
                        allowfullscreen="true">
                      </iframe>
                    </div>-->
                  <!--</mat-expansion-panel>
                </mat-card-content>
              </mat-card>
            </mat-tab>-->
            <!-- End ReRun Notebook Tab -->
          </mat-tab-group>
        </mat-card-content>
      </mat-card>
      <!-- End Right Column -->
    </div>
    <!-- End simulation information -->
  </ng-container>
</ng-container>
